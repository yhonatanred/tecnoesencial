<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema TECNOESENCIAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ESTILOS FUTURISTAS (HEREDADOS DE TU WEB) */
        :root {
            --bg-dark: #050510;
            --primary-blue: #00f3ff;
            --primary-purple: #bc13fe;
            --glass-bg: rgba(20, 20, 35, 0.8);
            --glass-border: rgba(0, 243, 255, 0.3);
            --text-main: #ffffff;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* Fondo Animado */
        .bg-glow { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, rgba(188,19,254,0.1), transparent), radial-gradient(circle at 80% 20%, rgba(0,243,255,0.15), transparent); z-index: -1; }

        .logo { font-family: 'Orbitron', sans-serif; font-size: 2rem; margin-bottom: 30px; text-align: center; color: white; text-shadow: 0 0 10px var(--primary-blue); }
        .logo span { color: var(--primary-blue); }

        /* Contenedores Glassmorphism */
        .panel { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 15px; padding: 30px; width: 100%; max-width: 500px; box-shadow: 0 0 20px rgba(0, 243, 255, 0.1); margin-bottom: 20px; display: none; }
        .panel.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-family: 'Orbitron', sans-serif; color: var(--primary-blue); margin-bottom: 20px; text-align: center; font-size: 1.5rem; }

        /* Formularios */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9rem; }
        input[type="text"], input[type="password"], input[type="number"], select, textarea {
            width: 100%; padding: 12px; background: rgba(0,0,0,0.5); border: 1px solid #444; border-radius: 8px; color: white; outline: none; transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-blue); box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        
        /* Checkboxes Neon para Inventario */
        .checkbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 5px; }
        .checkbox-item { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; color: #ddd; }
        .checkbox-item input { accent-color: var(--primary-purple); width: 18px; height: 18px; }

        /* Botones */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.3s; margin-top: 10px; font-family: 'Rajdhani', sans-serif; }
        .btn-blue { background: linear-gradient(90deg, #0055ff, var(--primary-blue)); color: white; box-shadow: 0 0 15px rgba(0, 243, 255, 0.4); }
        .btn-blue:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(0, 243, 255, 0.6); }
        .btn-outline { background: transparent; border: 1px solid var(--primary-purple); color: var(--primary-purple); }
        .btn-outline:hover { background: var(--primary-purple); color: white; }

        /* Rastreador Cliente */
        .timeline { border-left: 2px solid var(--primary-blue); padding-left: 20px; margin-top: 20px; }
        .timeline-item { position: relative; margin-bottom: 20px; }
        .timeline-item::before { content: ''; position: absolute; left: -27px; top: 0; width: 12px; height: 12px; background: var(--primary-blue); border-radius: 50%; box-shadow: 0 0 10px var(--primary-blue); }
        .timeline-date { font-size: 0.8rem; color: #888; }
        .timeline-text { color: #ddd; font-size: 0.95rem; margin-top: 5px; }

        /* Loader */
        .loader { display: none; text-align: center; margin-top: 15px; color: var(--primary-blue); font-size: 1.2rem; }
        
        .nav-buttons { display: flex; gap: 10px; max-width: 500px; width: 100%; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="bg-glow"></div>

    <div class="logo">TECNO<span>ESENCIAL</span></div>

    <div class="nav-buttons" id="nav-menu">
        <button class="btn btn-outline" onclick="mostrarPanel('panel-cliente')"><i class="fas fa-search"></i> Soy Cliente</button>
        <button class="btn btn-outline" onclick="mostrarPanel('panel-login')"><i class="fas fa-tools"></i> Soy T茅cnico</button>
    </div>

    <div class="panel active" id="panel-cliente">
        <h2>Rastrear mi Equipo</h2>
        <p style="text-align:center; color:#aaa; margin-bottom:20px;">Ingresa el c贸digo que te dio el t茅cnico.</p>
        <div class="form-group">
            <input type="text" id="ticket-id" placeholder="Ej: TCN-12345">
        </div>
        <button class="btn btn-blue" onclick="consultarTicket()">Buscar Estado</button>
        <div class="loader" id="loader-cliente"><i class="fas fa-spinner fa-spin"></i> Conectando al servidor...</div>
        
        <div id="resultado-cliente" style="display:none; margin-top:20px;">
            <h3 style="color:var(--primary-purple); border-bottom:1px solid #444; padding-bottom:10px;">Equipo: <span id="res-equipo"></span></h3>
            <div class="timeline" id="timeline-container">
                </div>
            <div style="margin-top:20px; padding:15px; background:rgba(0,0,0,0.5); border-radius:8px; text-align:center;">
                <span style="color:#aaa;">Costo Total Estimado:</span><br>
                <strong style="color:var(--primary-blue); font-size:1.5rem;" id="res-precio"></strong>
            </div>
        </div>
    </div>

    <div class="panel" id="panel-login">
        <h2>Acceso Autorizado</h2>
        <div class="form-group">
            <label>Usuario</label>
            <input type="text" id="login-user">
        </div>
        <div class="form-group">
            <label>Contrase帽a</label>
            <input type="password" id="login-pass">
        </div>
        <button class="btn btn-blue" onclick="iniciarSesion()">Ingresar</button>
        <div class="loader" id="loader-login"><i class="fas fa-spinner fa-spin"></i> Verificando credenciales...</div>
    </div>

    <div class="panel" id="panel-tecnico" style="max-width: 600px;">
        <h2>Nuevo Ingreso a Laboratorio</h2>
        <p style="text-align:center; color:#00f3ff; margin-bottom:20px;">T茅cnico: <span id="nombre-tecnico-activo"></span></p>

        <div class="form-group">
            <label>Nombre del Cliente</label>
            <input type="text" id="form-cliente" placeholder="Ej: Carlos Ram铆rez">
        </div>
        <div class="form-group">
            <label>WhatsApp del Cliente</label>
            <input type="number" id="form-whatsapp" placeholder="Ej: 3170000000">
        </div>
        <div class="form-group">
            <label>Direcci贸n de Recogida</label>
            <input type="text" id="form-direccion" placeholder="Ej: Palmira, Barrio Centro, Cll 10 #5-20">
        </div>
        <div class="form-group">
            <label>Equipo (Marca y Modelo)</label>
            <input type="text" id="form-equipo" placeholder="Ej: Port谩til HP Pavilion x360">
        </div>
        
        <div class="form-group">
            <label style="color:var(--primary-purple);">Inventario Recibido (Marca lo que entreg贸 el cliente)</label>
            <div class="checkbox-grid">
                <label class="checkbox-item"><input type="checkbox" class="inv-check" value="Cargador Original"> Cargador Original</label>
                <label class="checkbox-item"><input type="checkbox" class="inv-check" value="Cargador Gen茅rico"> Cargador Gen茅rico</label>
                <label class="checkbox-item"><input type="checkbox" class="inv-check" value="Malet铆n/Funda"> Malet铆n/Funda</label>
                <label class="checkbox-item"><input type="checkbox" class="inv-check" value="Mouse"> Mouse</label>
                <label class="checkbox-item"><input type="checkbox" class="inv-check" value="Cable de Poder"> Cable de Poder</label>
                <label class="checkbox-item"><input type="checkbox" class="inv-check" value="Sin Accesorios"> Equipo Solo (Sin Acc.)</label>
            </div>
        </div>

        <div class="form-group">
            <label>Diagn贸stico en Sitio / Da帽o Reportado</label>
            <textarea id="form-diagnostico" rows="3" placeholder="Ej: Equipo no da video. Bisagra izquierda rota."></textarea>
        </div>
        <div class="form-group">
            <label>Cotizaci贸n Inicial / Precio Estimado ($)</label>
            <input type="text" id="form-precio" placeholder="Ej: 160000">
        </div>

        <button class="btn btn-blue" onclick="crearTicket()">Registrar y Generar Ticket</button>
        <div class="loader" id="loader-registro"><i class="fas fa-spinner fa-spin"></i> Guardando en base de datos...</div>
    </div>

    <script>
        // 答答 PEGA AQU LA URL LARGA QUE COPIASTE DE GOOGLE APPS SCRIPT 答答
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx-LWwa4vgJh92Gj_LdDh9h7q1JyluC323gT9alNEpdk5YkJiOOLAZd29hFfb2ObRHC/exec";
        
        let tecnicoActual = ""; // Aqu铆 guardaremos qui茅n inici贸 sesi贸n

        // Funci贸n para cambiar entre pantallas
        function mostrarPanel(idPanel) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(idPanel).classList.add('active');
            
            // Ocultar botones de men煤 si entra el t茅cnico
            if(idPanel === 'panel-tecnico') {
                document.getElementById('nav-menu').style.display = 'none';
            }
        }

        // 1. FUNCIN DE LOGIN
        async function iniciarSesion() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const loader = document.getElementById('loader-login');

            if(!user || !pass) return alert("Completa los datos");

            loader.style.display = "block";

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ accion: "login", usuario: user, password: pass })
                });
                
                const result = await response.json();
                loader.style.display = "none";

                if(result.status === "success") {
                    tecnicoActual = result.data.nombre;
                    document.getElementById('nombre-tecnico-activo').innerText = tecnicoActual;
                    mostrarPanel('panel-tecnico');
                } else {
                    alert("Acceso Denegado: Usuario o contrase帽a incorrectos.");
                }
            } catch (error) {
                loader.style.display = "none";
                alert("Error de conexi贸n con la base de datos.");
            }
        }

        // 2. FUNCIN CREAR TICKET (TCNICO)
        async function crearTicket() {
            // Recoger los checks marcados
            let inventarioArr = [];
            document.querySelectorAll('.inv-check:checked').forEach(chk => inventarioArr.push(chk.value));
            
            const datosTicket = {
                accion: "crear_ticket",
                tecnico_principal: tecnicoActual,
                cliente: document.getElementById('form-cliente').value,
                whatsapp: document.getElementById('form-whatsapp').value,
                direccion: document.getElementById('form-direccion').value,
                equipo: document.getElementById('form-equipo').value,
                inventario: inventarioArr.join(", "),
                diagnostico: document.getElementById('form-diagnostico').value,
                cotizacion: document.getElementById('form-precio').value
            };

            if(!datosTicket.cliente || !datosTicket.equipo) return alert("El nombre y el equipo son obligatorios.");

            const loader = document.getElementById('loader-registro');
            loader.style.display = "block";

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(datosTicket)
                });
                
                const result = await response.json();
                loader.style.display = "none";

                if(result.status === "success") {
                    alert(`隆Ticket Creado con xito!\n\nEntrega este c贸digo al cliente: ${result.ticket}\nEnv铆ale el enlace de la web para que lo rastree.`);
                    // Limpiar formulario
                    document.querySelectorAll('input, textarea').forEach(el => el.value = '');
                    document.querySelectorAll('.inv-check').forEach(chk => chk.checked = false);
                } else {
                    alert("Error al guardar.");
                }
            } catch (error) {
                loader.style.display = "none";
                alert("Error de conexi贸n al guardar el ticket.");
            }
        }

        // 3. FUNCIN CONSULTAR TICKET (CLIENTE)
        async function consultarTicket() {
            const idTicket = document.getElementById('ticket-id').value.toUpperCase().trim();
            const loader = document.getElementById('loader-cliente');
            const resultadoDiv = document.getElementById('resultado-cliente');
            
            if(!idTicket) return alert("Por favor ingresa tu c贸digo de ticket.");

            loader.style.display = "block";
            resultadoDiv.style.display = "none";

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ accion: "consultar_ticket", id_ticket: idTicket })
                });
                
                const result = await response.json();
                loader.style.display = "none";

                if(result.status === "success") {
                    document.getElementById('res-equipo').innerText = result.ticket.equipo;
                    document.getElementById('res-precio').innerText = "$" + result.ticket.total;
                    
                    // Renderizar l铆nea de tiempo
                    const timeline = document.getElementById('timeline-container');
                    timeline.innerHTML = ""; // Limpiar
                    
                    result.historial.forEach(paso => {
                        timeline.innerHTML += `
                            <div class="timeline-item">
                                <div class="timeline-date">${paso.fecha} - Estado: <strong>${paso.estado}</strong></div>
                                <div class="timeline-text">${paso.detalle}</div>
                            </div>
                        `;
                    });
                    
                    resultadoDiv.style.display = "block";
                } else {
                    alert("No encontramos ese c贸digo en el sistema. Verifica que est茅 bien escrito.");
                }
            } catch (error) {
                loader.style.display = "none";
                alert("Error de conexi贸n buscando el ticket.");
            }
        }
    </script>
</body>
</html>